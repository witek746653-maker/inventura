<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
<meta name="theme-color" content="#0f1115" />
<style>
:root{
  --bg:#0f1115; --fg:#e7eaf0; --muted:#9aa3b2; --accent:#6f86ff; --line:#273047;
  --card:#151a22; --err:#ff5c5c; --chip:#20283a; --bright:#ffef5a;
  --pad:12px; --radius:12px; --fs:15px; --fs-sm:13px; --img:40px;
}
body.compact { --pad:10px; --radius:10px; --fs:14px; --fs-sm:12px; --img:32px; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f1115,#0f1115cc 60%,#0f111500);border-bottom:1px solid var(--line)}
h1{margin:0;font-size:18px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#121726;font-size:var(--fs-sm)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:9px;background:#141a28;cursor:pointer;font-size:var(--fs-sm)}
.tab.active{background:#1a2234;border-color:#30405f}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);margin:10px 0}
.btn{background:#1a2234;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:7px 10px;cursor:pointer;font-size:var(--fs-sm)}
.btn.primary{background:#6f86ff;border-color:#6f86ff;color:#fff}
.btn.ghost{background:transparent}
input,select,textarea{width:100%;background:#111827;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px;font-size:var(--fs-sm)}
.grid{display:grid;gap:8px}
.notice{padding:8px;border:1px dashed var(--line);border-radius:10px;color:#c9d2e1;background:#141a22;font-size:var(--fs-sm)}
.login-backdrop{position:fixed;inset:0;background:#0b0d1288;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:1000}
.login{width:min(520px,94vw);background:#111521;border:1px solid var(--line);border-radius:14px;padding:14px}
.list-head,.list-row{display:grid;grid-template-columns:52px 50px 1fr 150px;gap:8px;align-items:start}
.cell-img{width:var(--img);height:var(--img);object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#0c1020;cursor:zoom-in}
.pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:var(--fs-sm)}
.sum{display:inline-flex;gap:6px;align-items:center;border:1px dashed #4b536a;background:#1a2234;padding:4px 8px;border-radius:9px}
.sum .v{background:var(--bright);color:#111;padding:1px 6px;border-radius:8px;font-weight:800}
table{width:100%;border-collapse:collapse;font-size:var(--fs-sm)}
th,td{border-bottom:1px solid var(--line);padding:6px;vertical-align:top}
th{position:sticky;top:0;background:#141a24;z-index:1}
.switch{display:inline-flex;gap:6px;align-items:center;cursor:pointer}
@media (max-width:820px){
  .list-head,.list-row{grid-template-columns:40px 40px 1fr}
  .col-input{grid-column:1/-1}
}
.preview-grid{display:grid;grid-template-columns:50px 1fr 60px;gap:8px;align-items:center}
.preview-img{width:44px;height:44px;object-fit:cover;border:1px solid var(--line);border-radius:8px;background:#0c1020;cursor:zoom-in}

/* === –õ–∞–π—Ç–±–æ–∫—Å (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ) === */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:3000}
.lightbox.show{display:flex}
.lightbox-img{max-width:92vw;max-height:88vh;transform-origin:center center;touch-action:none;user-select:none}
.lightbox-ui{position:fixed;inset:auto 0 14px 0;display:flex;justify-content:center;gap:8px}
.lightbox-ui .btn{background:#111a;backdrop-filter:blur(6px);border-color:#333a}
.lightbox-top{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.lightbox-cap{color:#cfd6e6;font-size:13px;max-width:60vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h1>
    <div class="toolbar">
      <span class="badge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="who">‚Äî</strong></span>
      <button class="btn" id="btnChange">–°–º–µ–Ω–∏—Ç—å</button>
      <label class="switch"><input type="checkbox" id="compactToggle"> –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</label>
      <span class="badge">üíæ –û—Ñ–ª–∞–π–Ω</span>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>
</header>

<main class="wrap" id="app" aria-live="polite"></main>

<!-- –í–•–û–î -->
<div class="login-backdrop" id="loginScreen">
  <div class="login">
    <h2 style="margin:0 0 8px;font-size:18px">–í—Ö–æ–¥</h2>
    <div class="grid">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë –∏–º—è
        <select id="userSel" style="margin-top:6px"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>
      </label>
      <div id="codeRow" style="display:none">
        <div class="notice">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥.</div>
        <label>–ö–æ–¥ <input id="codeInp" inputmode="numeric" maxlength="4" placeholder="____" style="margin-top:6px" /></label>
      </div>
      <button class="btn primary" id="loginGo">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <div id="firstRunHint" class="notice" style="display:none">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–º–µ–Ω–∞.</div>
    </div>
  </div>
</div>

<!-- –õ–∞–π—Ç–±–æ–∫—Å -->
<div class="lightbox" id="imgBox" aria-hidden="true">
  <div class="lightbox-top">
    <div class="lightbox-cap" id="imgCap"></div>
    <button class="btn" id="imgClose">–ó–∞–∫—Ä—ã—Ç—å ‚úï</button>
  </div>
  <img id="imgBig" class="lightbox-img" alt="">
  <div class="lightbox-ui">
    <button class="btn" id="imgMinus">‚àí</button>
    <button class="btn" id="imgReset">–°–±—Ä–æ—Å</button>
    <button class="btn" id="imgPlus">Ôºã</button>
  </div>
</div>

<script>
/* ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ (IndexedDB + fallback) ===== */
const idb=(function(){
  const DB='invMobile_v3', V=1; let dbp=null;
  function open(){ if(dbp) return dbp; dbp=new Promise((res,rej)=>{
    const r=indexedDB.open(DB,V);
    r.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'id'});
      if(!db.objectStoreNames.contains('items')) db.createObjectStore('items',{keyPath:'id'});
      if(!db.objectStoreNames.contains('assign')) db.createObjectStore('assign',{keyPath:'itemId'});
      if(!db.objectStoreNames.contains('entries')) db.createObjectStore('entries',{keyPath:'key'});
      if(!db.objectStoreNames.contains('snaps')) db.createObjectStore('snaps',{keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  }); return dbp;}
  async function rw(mode,store){const db=await open();return db.transaction([store],mode).objectStore(store)}
  const LS='inv_fb_mobile_v3', read=()=>{try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}}}, write=o=>localStorage.setItem(LS,JSON.stringify(o));
  async function tryCall(fn){try{return await fn()}catch{return{__fb:true}}}
  return{
    async set(s,v){const r=await tryCall(async()=>{const o=await rw('readwrite',s);await new Promise((res,rej)=>{const q=o.put(v);q.onsuccess=res;q.onerror=()=>rej(q.error)});return v}); if(r&&r.__fb){const db=read();(db[s]??={})[v.id||v.key]=v;write(db)}return v},
    async get(s,k){const r=await tryCall(async()=>{const o=await rw('readonly',s);return await new Promise((res,rej)=>{const q=o.get(k);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read();return db[s]?.[k]} return r},
    async all(s){const r=await tryCall(async()=>{const o=await rw('readonly',s);return await new Promise((res,rej)=>{const q=o.getAll();q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read();return Object.values(db[s]||{})} return r},
    async del(s,k){const r=await tryCall(async()=>{const o=await rw('readwrite',s);return await new Promise((res,rej)=>{const q=o.delete(k);q.onsuccess=res;q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read(); if(db[s]) delete db[s][k]; write(db)}}
  }
})();

/* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / —É—Ç–∏–ª–∏—Ç—ã / —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
const RESPONSIBLE_CODE='5878';
const uid=(p='id')=>`${p}_${Math.random().toString(36).slice(2,7)}${Date.now().toString(36)}`;
const now=()=>new Date().toISOString();
const sum=xs=>(xs||[]).reduce((a,b)=>a+(+b.value||0),0);
const byOrder=(a,b)=>(a.order||0)-(b.order||0);
const state={user:null,tabs:[], _loginTimer:null};
const ALWAYS_ASK_LOGIN=true;

/* ===== –î–∞–Ω–Ω—ã–µ ===== */
async function ensureSeed(){
  const users=await idb.all('users');
  if(!users.length){
    await idb.set('users',{id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible',active:true,createdAt:now()});
  }
}
async function listUsers(){ return (await idb.all('users')).filter(u=>u.active!==false).sort((a,b)=>a.name.localeCompare(b.name,'ru')) }
async function listItems(){ return (await idb.all('items')).sort(byOrder) }
async function getAssign(){ const a=await idb.all('assign'); return new Map(a.map(x=>[x.itemId,x.userId])) }
async function setAssign(itemId,userId){ await idb.set('assign',{itemId,userId}) }
async function getEntry(userId,itemId){ return await idb.get('entries',`${userId}|${itemId}`) || {key:`${userId}|${itemId}`,userId,itemId,values:[],comment:''} }
async function setEntry(e){ await idb.set('entries',e) }
async function allEntries(){ return await idb.all('entries') }
async function clearCurrent(){ for(const e of await idb.all('entries')) await idb.del('entries',e.key) }
async function makeSnap(title,byUser){
  const items=await listItems(), users=await listUsers(), ent=await allEntries(), totals={};
  for(const it of items){
    const byU={}; for(const u of users){ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); byU[u.id]=e?sum(e.values):0 }
    totals[it.id]={overall:Object.values(byU).reduce((a,b)=>a+b,0),byUser:byU};
  }
  const snap={id:uid('snap'),title,createdAt:now(),createdBy:byUser.id,totals,items,users,comments:[]};
  await idb.set('snaps',snap); return snap;
}
async function listSnaps(){ const s=await idb.all('snaps'); return s.sort((a,b)=>a.createdAt>b.createdAt?-1:1) }

/* ===== –í–∫–ª–∞–¥–∫–∏ ===== */
function setTabs(){
  const isResp=state.user?.role==='responsible';
  state.tabs=[{id:'mine',label:'–ú–æ—è —á–∞—Å—Ç—å'}, ...(isResp?[{id:'total',label:'–ò—Ç–æ–≥'},{id:'manage',label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏'}]:[]), {id:'history',label:'–ò—Å—Ç–æ—Ä–∏—è'}];
}
function drawTabs(){
  const bar=document.getElementById('tabs'); bar.innerHTML='';
  const current=location.hash.slice(1)||state.tabs[0]?.id;
  for(const t of state.tabs){
    const b=document.createElement('button'); b.className='tab'+(current===t.id?' active':''); b.textContent=t.label;
    b.onclick=()=>{location.hash=t.id; render()}; bar.appendChild(b);
  }
}

/* ===== –í—Ö–æ–¥ ===== */
async function fillUsersIntoSelect(){
  const sel=document.getElementById('userSel'); if(!sel) return;
  const prev=sel.value;
  sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`;
  const users=await listUsers();
  for(const u of users){
    const opt=document.createElement('option');
    opt.value=u.id; opt.textContent=u.name+(u.role==='responsible'?' (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)':'');
    opt.dataset.role=u.role; sel.appendChild(opt);
  }
  if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
  const noUsers = sel.options.length<=1;
  document.getElementById('codeRow').style.display = (sel.selectedOptions[0]?.dataset.role==='responsible' || noUsers) ? 'block' : 'none';
  document.getElementById('firstRunHint').style.display = noUsers ? 'block':'none';
}
document.getElementById('userSel').addEventListener('change',()=>fillUsersIntoSelect());

document.getElementById('loginGo').onclick=async()=>{
  const sel=document.getElementById('userSel');
  const users=await listUsers();
  let picked=null;

  if(sel.value){
    picked = users.find(u=>u.id===sel.value);
    if(!picked) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    if(picked.role==='responsible'){
      const code=(document.getElementById('codeInp').value||'').trim();
      if(code!==RESPONSIBLE_CODE) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    }
  } else {
    const code=(document.getElementById('codeInp').value||'').trim();
    if(code!==RESPONSIBLE_CODE) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    picked = users.find(u=>u.role==='responsible') || {id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible',active:true,createdAt:now()};
    await idb.set('users',picked);
  }

  state.user=picked;
  localStorage.setItem('inv_user',JSON.stringify(state.user));
  stopLoginAutoRefresh();
  document.getElementById('loginScreen').style.display='none';
  render();
};

document.getElementById('btnChange').onclick=async()=>{
  localStorage.removeItem('inv_user');
  await fillUsersIntoSelect();
  document.getElementById('codeInp').value='';
  document.getElementById('loginScreen').style.display='';
  startLoginAutoRefresh();
};

function startLoginAutoRefresh(){ stopLoginAutoRefresh(); state._loginTimer=setInterval(fillUsersIntoSelect,2000) }
function stopLoginAutoRefresh(){ if(state._loginTimer){clearInterval(state._loginTimer); state._loginTimer=null} }

/* ===== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ===== */
(function initCompact(){
  const key='inv_compact_mode';
  const chk=document.getElementById('compactToggle');
  const saved=localStorage.getItem(key)==='1';
  if(saved){ document.body.classList.add('compact'); chk.checked=true; }
  chk.onchange=()=>{ document.body.classList.toggle('compact',chk.checked); localStorage.setItem(key, chk.checked?'1':'0'); };
})();

/* ===== –õ–∞–π—Ç–±–æ–∫—Å (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ) ===== */
(function initLightbox(){
  const box = document.getElementById('imgBox');
  const img = document.getElementById('imgBig');
  const cap = document.getElementById('imgCap');
  const btnPlus = document.getElementById('imgPlus');
  const btnMinus = document.getElementById('imgMinus');
  const btnReset = document.getElementById('imgReset');
  const btnClose = document.getElementById('imgClose');

  let scale=1, dx=0, dy=0, startX=0, startY=0, panning=false, lastTap=0, pinchDist=null;

  function apply(){ img.style.transform = `translate(${dx}px,${dy}px) scale(${scale})`; }
  function open(src, caption=''){
    img.src=src; cap.textContent=caption||''; scale=1; dx=0; dy=0; apply();
    box.classList.add('show'); box.setAttribute('aria-hidden','false'); img.focus?.();
  }
  function close(){ box.classList.remove('show'); box.setAttribute('aria-hidden','true'); }

  btnPlus.onclick=()=>{ scale=Math.min(8, scale*1.2); apply(); };
  btnMinus.onclick=()=>{ scale=Math.max(0.25, scale/1.2); apply(); };
  btnReset.onclick=()=>{ scale=1; dx=0; dy=0; apply(); };
  btnClose.onclick=close;

  // –∫–ª–∏–∫–∏ –≤–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç
  box.addEventListener('click',e=>{ if(e.target===box) close(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') close(); });

  // –∫–æ–ª–µ—Å–æ –¥–ª—è –∑—É–º–∞
  box.addEventListener('wheel',e=>{ e.preventDefault(); const delta = Math.sign(e.deltaY); if(delta>0) btnMinus.onclick(); else btnPlus.onclick(); }, {passive:false});

  // –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º—ã—à—å—é
  img.addEventListener('mousedown',e=>{ panning=true; startX=e.clientX-dx; startY=e.clientY-dy; e.preventDefault(); });
  window.addEventListener('mousemove',e=>{ if(!panning) return; dx=e.clientX-startX; dy=e.clientY-startY; apply(); });
  window.addEventListener('mouseup',()=>{ panning=false; });

  // touch: –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø –∏ pinch-zoom + –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
  img.addEventListener('touchstart',e=>{
    if(e.touches.length===1){
      const now=Date.now();
      if(now-lastTap<300){ // double tap
        scale = scale<1.8 ? 2 : 1;
        dx=0; dy=0; apply();
      }
      lastTap=now;
      panning=true; startX=e.touches[0].clientX-dx; startY=e.touches[0].clientY-dy;
      pinchDist=null;
    }else if(e.touches.length===2){
      panning=false;
      const [a,b]=e.touches; pinchDist=Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
    }
  }, {passive:true});
  img.addEventListener('touchmove',e=>{
    if(e.touches.length===1 && panning){
      dx=e.touches[0].clientX-startX; dy=e.touches[0].clientY-startY; apply();
    }else if(e.touches.length===2 && pinchDist){
      const [a,b]=e.touches;
      const d=Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
      const factor=d/pinchDist; pinchDist=d;
      scale=Math.max(0.25, Math.min(8, scale*factor)); apply();
    }
  }, {passive:true});
  img.addEventListener('touchend',()=>{ panning=false; pinchDist=null; });

  // –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
  window._openLightbox = open;
})();

/* ===== –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ===== */
async function viewMine(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const assigns=await getAssign(); const ent=await allEntries();
  const hasAssign=(await idb.all('assign')).length>0;
  const myId=state.user.id;
  const list=hasAssign ? items.filter(i=>assigns.get(i.id)===myId) : items;

  app.appendChild(el(`<div class="notice card">${hasAssign?`–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <b>${list.length}</b>.`:`–†–∞–∑–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤–∏–¥–Ω—ã –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏: <b>${items.length}</b>.`}</div>`));

  const box=el(`<div class="card">
    <div class="list-head"><div>‚Ññ</div><div>–§–æ—Ç–æ</div><div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –≤–≤–æ–¥</div><div class="col-input">–í–≤–æ–¥</div></div>
    <div id="rows"></div>
  </div>`); app.appendChild(box);
  const rows=box.querySelector('#rows');

  for(const it of list){
    const e=ent.find(x=>x.userId===myId && x.itemId===it.id) || {key:`${myId}|${it.id}`,userId:myId,itemId:it.id,values:[],comment:''};
    const total=sum(e.values);
    const img = it.photo ? `<img class="cell-img" src="${it.photo}" alt="${(it.name||'').replace(/"/g,'&quot;')}">` : `<div class="cell-img" title="–Ω–µ—Ç —Ñ–æ—Ç–æ"></div>`;
    const row=el(`<div class="list-row">
      <div>#${it.order||''}</div>
      <div>${img}</div>
      <div>
        <div style="font-weight:600">${it.name||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}</div>
        <div class="muted" style="font-size:12px">${it.description||''}</div>
        <div class="pills" id="vals_${it.id}">
          ${e.values.map(v=>`<span class="pill" data-vid="${v.id}">${v.value}
            <button class="btn ghost" data-e="edit" title="–ò–∑–º.">‚úèÔ∏è</button>
            <button class="btn ghost" data-e="del" title="–£–¥.">üóëÔ∏è</button>
          </span>`).join('')}
        </div>
        <textarea id="c_${it.id}" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" style="margin-top:6px">${e.comment||''}</textarea>
        <div class="grid" style="grid-template-columns:auto 1fr;align-items:center;margin-top:6px">
          <span>üí¨</span><button class="btn" data-savec="${it.id}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </div>
      </div>
      <div class="col-input">
        <div class="grid" style="grid-template-columns:1fr auto auto;gap:6px">
          <input type="number" step="1" inputmode="numeric" id="n_${it.id}" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ">
          <button class="btn primary" data-add="${it.id}">Ôºã</button>
          <button class="btn" data-reset="${it.id}">‚ü≤</button>
        </div>
        <div class="sum" style="margin-top:6px">–ò—Ç–æ–≥–æ: <span class="v" id="s_${it.id}">${total}</span></div>
      </div>
    </div>`);
    rows.appendChild(row);

    // –∫–ª–∏–∫–∏ –ø–æ –º–∏–Ω–∏-–∫–∞—Ä—Ç–∏–Ω–∫–∞–º -> –ª–∞–π—Ç–±–æ–∫—Å
    const mini=row.querySelector('.cell-img');
    if(mini && mini.tagName==='IMG'){
      mini.addEventListener('click',()=>window._openLightbox(mini.src, mini.alt||''));
    }

    row.querySelector(`[data-add="${it.id}"]`).onclick=async()=>{
      const v=parseFloat(row.querySelector(`#n_${it.id}`).value);
      if(isNaN(v)) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
      e.values.push({id:uid('v'),value:v,ts:now()}); await setEntry(e); render();
    };
    row.querySelector(`[data-reset="${it.id}"]`).onclick=async()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏?'))return;
      e.values=[]; await setEntry(e); render();
    };
    row.querySelector(`[data-savec="${it.id}"]`).onclick=async()=>{
      e.comment=row.querySelector(`#c_${it.id}`).value; await setEntry(e);
    };
    row.querySelectorAll(`#vals_${it.id} .pill`).forEach(p=>{
      const vid=p.getAttribute('data-vid');
      p.querySelector('[data-e="del"]').onclick=async()=>{ e.values=e.values.filter(x=>x.id!==vid); await setEntry(e); render(); };
      p.querySelector('[data-e="edit"]').onclick=async()=>{
        const found=e.values.find(x=>x.id===vid); const nv=prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',found.value);
        if(nv===null) return; const n=parseFloat(nv); if(isNaN(n)) return;
        found.value=n; await setEntry(e); render();
      };
    });
  }
}

async function viewTotal(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const users=await listUsers(); const ent=await allEntries(); const assigns=await getAssign();

  /* === –ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV === */
  const importCard=el(`<div class="card grid">
    <h3 style="margin:0">–ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV</h3>
    <div class="notice">
      –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –≤ Excel –∫–∞–∫ <b>CSV UTF-8</b>.<br>
      –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: <code>‚Ññ</code> / <code>order</code> (—á–∏—Å–ª–æ). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: <code>–Ω–∞–∑–≤–∞–Ω–∏–µ | name</code>, <code>–æ–ø–∏—Å–∞–Ω–∏–µ | description</code>, <code>—Ñ–æ—Ç–æ | photo</code> (URL –∏–ª–∏ data:URI).<br>
      –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ —Å –Ω–æ–º–µ—Ä–æ–º –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∏–º –ø–æ–ª–µ–º (–Ω–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ/—Ñ–æ—Ç–æ).
    </div>
    <div class="grid" style="grid-template-columns:1fr auto;gap:8px">
      <input type="file" id="csvFile" accept=".csv,.txt" />
      <button class="btn" id="importBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </div>`);
  app.appendChild(importCard);

  importCard.querySelector('#importBtn').onclick=async()=>{
    const f=importCard.querySelector('#csvFile').files[0];
    if(!f) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª CSV');
    const text=await f.text();
    const rows=parseCSV(text);
    if(!rows.length) return alert('–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª');
    const headers=rows[0].map(h=>normalizeHeader(h));
    const idx={
      order: headers.findIndex(h=>['order','–Ω–æ–º–µ—Ä','‚Ññ','#'].includes(h)),
      name: headers.findIndex(h=>['name','–Ω–∞–∑–≤–∞–Ω–∏–µ','–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','item'].includes(h)),
      description: headers.findIndex(h=>['description','–æ–ø–∏—Å–∞–Ω–∏–µ','desc'].includes(h)),
      photo: headers.findIndex(h=>['photo','—Ñ–æ—Ç–æ','image','img','pic'].includes(h)),
    };
    if (idx.order < 0){ alert('–ù–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ "‚Ññ" –∏–ª–∏ "order".'); return; }
    let count=0;
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r || !r.length) continue;
      const ordStr = String(r[idx.order]??'').replace(/[^\d\-]/g,'').trim();
      if(!ordStr) continue;
      const ord = parseInt(ordStr,10); if(Number.isNaN(ord)) continue;
      const name = idx.name>=0 ? String(r[idx.name]??'').trim() : '';
      const description = idx.description>=0 ? String(r[idx.description]??'').trim() : '';
      const photo = idx.photo>=0 ? String(r[idx.photo]??'').trim() : '';
      if(!name && !description && !photo) continue;

      const existed = (await listItems()).find(it=>(it.order||0)===ord);
      if(existed){
        await idb.set('items',{...existed,order:ord,name:name||existed.name||`–ü–æ–∑–∏—Ü–∏—è ${ord}`,description,photo});
      }else{
        await idb.set('items',{id:uid('it'),order:ord,name:name||`–ü–æ–∑–∏—Ü–∏—è ${ord}`,description,photo});
      }
      count++;
    }
    alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${count}`); render();
  };

  /* === –ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–º–∞—Å—Å–æ–≤–æ) === */
  const imgCard=el(`<div class="card grid">
    <h3 style="margin:0">–ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫</h3>
    <div class="notice">
      –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ä–∞–∑—É –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ (jpg/png/webp). –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: –ø–æ –Ω–æ–º–µ—Ä—É (12.jpg ‚Üí ‚Ññ12) –∏–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤).<br>
      –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Å—Å—ã–ª–∫–æ–π (—É–∫–∞–∂–∏—Ç–µ URL-–ø—Ä–µ—Ñ–∏–∫—Å) –∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–æ (base64).
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
      <div class="grid">
        <label>–§–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          <input id="imgFiles" type="file" accept="image/*" multiple>
        </label>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:6px">
          <label><input type="radio" name="matchMode" value="number" checked> –ü–æ –Ω–æ–º–µ—Ä—É</label>
          <label><input type="radio" name="matchMode" value="name"> –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</label>
        </div>
      </div>
      <div class="grid">
        <label>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ
          <select id="saveMode">
            <option value="url">–°—Å—ã–ª–∫–æ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
            <option value="data">–í—Å—Ç—Ä–æ–µ–Ω–æ (base64)</option>
          </select>
        </label>
        <label>URL-–ø—Ä–µ—Ñ–∏–∫—Å (–¥–ª—è —Ä–µ–∂–∏–º–∞ ¬´–°—Å—ã–ª–∫–æ–π¬ª)
          <input id="urlPrefix" placeholder="/images/ –∏–ª–∏ https://‚Ä¶/img/">
        </label>
        <button class="btn" id="imgImportBtn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏</button>
      </div>
    </div>
    <div id="imgPreview" class="grid"></div>
  </div>`);
  app.appendChild(imgCard);

  imgCard.querySelector('#imgImportBtn').onclick=async()=>{
    const files=[...imgCard.querySelector('#imgFiles').files];
    if(!files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫');
    const matchMode = imgCard.querySelector('input[name="matchMode"]:checked').value;
    const saveMode = imgCard.querySelector('#saveMode').value;
    const prefix = (imgCard.querySelector('#urlPrefix').value||'').trim();

    const allItems = await listItems();
    const byOrder = new Map(allItems.map(it=>[String(it.order||''), it]));
    const byName = new Map(allItems.map(it=>[normalizeName(it.name||''), it]));

    let matched=0, updated=0;
    const preview = imgCard.querySelector('#imgPreview'); preview.innerHTML='';

    const readAsDataURL=f=>new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(f);});

    for(const f of files){
      let item=null;
      const base = f.name.replace(/\.[^.]+$/,'');
      if(matchMode==='number'){
        const m=f.name.match(/(\d{1,6})/);
        if(m){ item=byOrder.get(m[1]); }
      }else{
        item=byName.get(normalizeName(base));
      }
      if(!item) continue;

      let photoValue='';
      if(saveMode==='url'){
        if(!prefix){ alert('–£–∫–∞–∂–∏—Ç–µ URL-–ø—Ä–µ—Ñ–∏–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, /images/)'); return; }
        photoValue = (prefix.endsWith('/')?prefix:(prefix+'/')) + f.name;
      }else{
        photoValue = await readAsDataURL(f);
      }

      await idb.set('items',{...item, photo:photoValue});
      updated++;

      const row=document.createElement('div');
      row.className='preview-grid';
      row.innerHTML=`<div>#${item.order||''}</div><div>${item.name||''}</div><img class="preview-img" src="${photoValue}" alt="${(item.name||'').replace(/"/g,'&quot;')}">`;
      // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é –≤ –æ—Ç—á—ë—Ç–µ
      row.querySelector('.preview-img').addEventListener('click',e=>window._openLightbox(photoValue, item.name||''));
      preview.appendChild(row);
      matched++;
    }
    alert(`–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${matched}. –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${updated}.`);
    render();
  };

  // –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ + –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
  const tbl=el(`<div class="card" style="overflow:auto">
    <table><thead><tr>
      <th>‚Ññ</th><th>–§–æ—Ç–æ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th><th>–ù–∞–∑–Ω–∞—á–µ–Ω–æ</th>
    </tr></thead><tbody id="tb"></tbody></table>
  </div>`); app.appendChild(tbl);
  const tb=tbl.querySelector('#tb');
  for(const it of items){
    const img = it.photo ? `<img class="cell-img" src="${it.photo}" alt="${(it.name||'').replace(/"/g,'&quot;')}">` : '';
    const row=el(`<tr>
      <td>${it.order||''}</td>
      <td>${img}</td>
      <td><div style="font-weight:600">${it.name||''}</div><div class="muted" style="font-size:12px">${it.description||''}</div></td>
      ${users.map(u=>{ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); return `<td>${e?sum(e.values):0}</td>`; }).join('')}
      <td><b>${ users.map(u=>{const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id);return e?sum(e.values):0}).reduce((a,b)=>a+b,0) }</b></td>
      <td><select data-assign="${it.id}">${users.map(u=>`<option value="${u.id}" ${assigns.get(it.id)===u.id?'selected':''}>${u.name}</option>`).join('')}</select></td>
    </tr>`);
    tb.appendChild(row);

    const mini=row.querySelector('.cell-img');
    if(mini){
      mini.addEventListener('click',()=>window._openLightbox(mini.src, mini.alt||''));
    }

    row.querySelector(`[data-assign="${it.id}"]`).onchange=async e=>{ await setAssign(it.id,e.target.value) };
  }

  // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
  const tools=el(`<div class="card grid" style="grid-template-columns:1fr auto;align-items:end">
    <div>
      <h3 style="margin:0 0 6px;font-size:15px">–†–∞–∑–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</h3>
      <div class="grid" style="grid-template-columns:110px auto;gap:6px">
        <input id="splitN" type="number" min="1" step="1" value="2">
        <button class="btn primary" id="doSplit">–†–∞–∑–¥–µ–ª–∏—Ç—å</button>
      </div>
      <div class="notice" style="margin-top:6px">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤ —Å—Ç–æ–ª–±—Ü–µ ¬´–ù–∞–∑–Ω–∞—á–µ–Ω–æ¬ª.</div>
    </div>
    <div class="grid" style="grid-auto-flow:column;gap:6px">
      <button class="btn primary" id="snap">–ó–∞–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é</button>
      <button class="btn" id="clear">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é</button>
    </div>
  </div>`); app.appendChild(tools);

  tools.querySelector('#doSplit').onclick=async()=>{
    const n=Math.max(1,parseInt(tools.querySelector('#splitN').value||'1',10));
    const arr=items.slice().sort(byOrder); const members=(await listUsers());
    if(members.length<n){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); return }
    const chunk=Math.ceil(arr.length/n);
    for(let i=0;i<n;i++){ for(const it of arr.slice(i*chunk,(i+1)*chunk)){ await setAssign(it.id,members[i].id) } }
    render();
  };
  tools.querySelector('#snap').onclick=async()=>{
    const title=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–≤–≥—É—Å—Ç 2025):'); if(!title) return;
    await makeSnap(title,state.user); alert('–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    location.hash='#history'; render();
  };
  tools.querySelector('#clear').onclick=async()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é? –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —Ç—Ä–æ–Ω–µ—Ç—Å—è.')){ await clearCurrent(); render(); } };
}

async function viewManage(){
  const app=document.getElementById('app'); app.innerHTML='';
  const users=await listUsers();
  const ucard=el(`<div class="card">
    <h3 style="margin:0 0 6px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
    <div id="ulist"></div>
    <div class="grid" style="grid-template-columns:1fr 160px auto;gap:6px;margin-top:6px">
      <input id="newU" placeholder="–ò–º—è">
      <select id="newR"><option value="waiter">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option><option value="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option></select>
      <button class="btn primary" id="addU">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>`); app.appendChild(ucard);
  const UL=ucard.querySelector('#ulist');
  for(const u of users){
    const r=el(`<div class="grid" style="grid-template-columns:1fr 160px auto auto;gap:6px;margin:6px 0">
      <input id="nm_${u.id}" value="${u.name}">
      <select id="rl_${u.id}">
        <option value="waiter" ${u.role==='waiter'?'selected':''}>–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option>
        <option value="responsible" ${u.role==='responsible'?'selected':''}>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
      </select>
      <button class="btn" data-save="${u.id}">üíæ</button>
      <button class="btn" data-hide="${u.id}">–°–∫—Ä—ã—Ç—å</button>
    </div>`); UL.appendChild(r);
    r.querySelector(`[data-save="${u.id}"]`).onclick=async()=>{
      await idb.set('users',{...u,name:r.querySelector(`#nm_${u.id}`).value.trim()||u.name,role:r.querySelector(`#rl_${u.id}`).value});
      if(state.user.id===u.id){ state.user=await idb.get('users',u.id); localStorage.setItem('inv_user',JSON.stringify(state.user)); }
      render();
    };
    r.querySelector(`[data-hide="${u.id}"]`).onclick=async()=>{ await idb.set('users',{...u,active:false}); render(); };
  }
  ucard.querySelector('#addU').onclick=async()=>{
    const name=ucard.querySelector('#newU').value.trim(); if(!name) return alert('–ò–º—è?');
    const role=ucard.querySelector('#newR').value; await idb.set('users',{id:uid('u'),name,role,active:true,createdAt:now()}); render();
  };

  const items=await listItems();
  const icard=el(`<div class="card">
    <h3 style="margin:0 0 6px">–ü–æ–∑–∏—Ü–∏–∏</h3>
    <div id="ilist"></div>
    <div class="grid" style="grid-template-columns:100px 1fr 2fr 1fr auto;gap:6px;margin-top:6px">
      <input id="io" type="number" placeholder="‚Ññ">
      <input id="in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <input id="id" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
      <input id="ip" placeholder="–§–æ—Ç–æ (URL)">
      <button class="btn primary" id="addI">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>`); app.appendChild(icard);
  const IL=icard.querySelector('#ilist');
  for(const it of items){
    const img = it.photo ? `<img class="cell-img" src="${it.photo}" alt="${(it.name||'').replace(/"/g,'&quot;')}">` : '';
    const r=el(`<div class="grid" style="grid-template-columns:60px 40px 1fr 2fr 1fr auto auto;gap:6px;margin:6px 0;align-items:center">
      <input id="o_${it.id}" type="number" value="${it.order||0}">
      <div>${img}</div>
      <input id="n_${it.id}" value="${it.name||''}">
      <input id="d_${it.id}" value="${it.description||''}">
      <input id="p_${it.id}" value="${it.photo||''}" placeholder="URL / data:">
      <button class="btn" data-save="${it.id}">üíæ</button>
      <button class="btn" data-del="${it.id}">üóëÔ∏è</button>
    </div>`); IL.appendChild(r);

    const mini=r.querySelector('.cell-img');
    if(mini){
      mini.addEventListener('click',()=>window._openLightbox(mini.src, mini.alt||''));
    }

    r.querySelector(`[data-save="${it.id}"]`).onclick=async()=>{
      await idb.set('items',{...it,
        order:parseInt(r.querySelector(`#o_${it.id}`).value||'0',10),
        name:r.querySelector(`#n_${it.id}`).value.trim(),
        description:r.querySelector(`#d_${it.id}`).value.trim(),
        photo:r.querySelector(`#p_${it.id}`).value.trim()
      });
      render();
    };
    r.querySelector(`[data-del="${it.id}"]`).onclick=async()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')){ await idb.del('items',it.id); render(); } };
  }
  icard.querySelector('#addI').onclick=async()=>{
    const oo=parseInt(icard.querySelector('#io').value||'0',10);
    const nn=icard.querySelector('#in').value.trim(); if(!nn) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ?');
    const dd=icard.querySelector('#id').value.trim();
    const pp=icard.querySelector('#ip').value.trim();
    await idb.set('items',{id:uid('it'),order:oo,name:nn,description:dd,photo:pp});
    render();
  };
}

async function viewHistory(){
  const app=document.getElementById('app'); app.innerHTML='';
  const snaps=await listSnaps();
  if(!snaps.length){ app.appendChild(el(`<div class="card notice">–°–Ω–∏–º–∫–æ–≤ –Ω–µ—Ç.</div>`)); return }
  for(const s of snaps){
    const card=el(`<div class="card" style="overflow:auto">
      <div><b>${s.title}</b> <span style="color:#9aa3b2">‚Äî ${new Date(s.createdAt).toLocaleString('ru-RU')}</span></div>
      <table style="margin-top:6px"><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${s.users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th></tr></thead>
      <tbody id="tb_${s.id}"></tbody></table>
    </div>`); app.appendChild(card);
    const tb=card.querySelector(`#tb_${s.id}`);
    for(const it of s.items.sort(byOrder)){
      const t=s.totals[it.id]; if(!t) continue;
      tb.appendChild(el(`<tr><td>${it.order||''}</td><td>${it.name||''}</td>${s.users.map(u=>`<td>${t.byUser[u.id]||0}</td>`).join('')}<td><b>${t.overall||0}</b></td></tr>`));
    }
  }
}

/* ===== CSV Parser ===== */
function parseCSV(text){
  text=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
  const comma=(text.match(/,/g)||[]).length, semi=(text.match(/;/g)||[]).length;
  const sep = semi>comma ? ';' : ',';
  const rows=[]; let i=0, cell='', row=[], inQ=false;
  while(i<text.length){
    const ch=text[i];
    if(inQ){
      if(ch==='"' && text[i+1]==='"'){ cell+='"'; i+=2; continue; }
      if(ch==='"'){ inQ=false; i++; continue; }
      cell+=ch; i++; continue;
    }else{
      if(ch==='"'){ inQ=true; i++; continue; }
      if(ch===sep){ row.push(cell); cell=''; i++; continue; }
      if(ch==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; i++; continue; }
      cell+=ch; i++; continue;
    }
  }
  row.push(cell); rows.push(row);
  return rows.filter(r=>Array.isArray(r) && r.some(c=>String(c??'').trim()!==''));
}
function normalizeHeader(h){ return String(h||'').toLowerCase().trim().replace(/\s+/g,'') }
function normalizeName(s){ return String(s||'').toLowerCase().replace(/[\s_\-.,;:()"'`~!@#\$%\^&\*\+=\[\]{}<>\/\\|]+/g,'').trim() }

/* ===== –•–µ–ª–ø–µ—Ä—ã ===== */
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
async function render(){
  setTabs(); drawTabs();
  document.getElementById('who').textContent=state.user?.name||'‚Äî';
  const hash=location.hash.slice(1)||state.tabs[0].id;
  if(hash==='mine') await viewMine();
  if(hash==='total') await viewTotal();
  if(hash==='manage') await viewManage();
  if(hash==='history') await viewHistory();
}

/* ===== –ó–∞–ø—É—Å–∫ ===== */
(async function boot(){
  await ensureSeed();
  if (ALWAYS_ASK_LOGIN) localStorage.removeItem('inv_user');
  try{ const u=JSON.parse(localStorage.getItem('inv_user')||'null'); if(u&&u.id) state.user=u; }catch{}
  if(!state.user){
    await fillUsersIntoSelect();
    document.getElementById('loginScreen').style.display='';
    startLoginAutoRefresh();
  }else{
    document.getElementById('loginScreen').style.display='none';
    render();
  }
})();
</script>
</body>
</html>

