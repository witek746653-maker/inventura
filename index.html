<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
<meta name="theme-color" content="#0f1115" />
<style>
:root{
  --bg:#0f1115; --fg:#e7eaf0; --muted:#9aa3b2; --accent:#6f86ff; --line:#273047;
  --card:#151a22; --err:#ff5c5c; --chip:#20283a; --bright:#ffef5a;
  --pad:12px; --radius:12px; --fs:15px; --fs-sm:13px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f1115,#0f1115cc 60%,#0f111500);border-bottom:1px solid var(--line)}
h1{margin:0;font-size:18px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#121726;font-size:var(--fs-sm)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:9px;background:#141a28;cursor:pointer;font-size:var(--fs-sm)}
.tab.active{background:#1a2234;border-color:#30405f}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);margin:10px 0}
.btn{background:#1a2234;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:7px 10px;cursor:pointer;font-size:var(--fs-sm)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.ghost{background:transparent}
input,select,textarea{width:100%;background:#111827;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px;font-size:var(--fs-sm)}
.grid{display:grid;gap:8px}
.notice{padding:8px;border:1px dashed var(--line);border-radius:10px;color:#c9d2e1;background:#141a22;font-size:var(--fs-sm)}
.login-backdrop{position:fixed;inset:0;background:#0b0d1288;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:1000}
.login{width:min(520px,94vw);background:#111521;border:1px solid var(--line);border-radius:14px;padding:14px}
.list-head,.list-row{display:grid;grid-template-columns:52px 1fr 150px;gap:8px;align-items:start}
.pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:var(--fs-sm)}
.sum{display:inline-flex;gap:6px;align-items:center;border:1px dashed #4b536a;background:#1a2234;padding:4px 8px;border-radius:9px}
.sum .v{background:var(--bright);color:#111;padding:1px 6px;border-radius:8px;font-weight:800}
table{width:100%;border-collapse:collapse;font-size:var(--fs-sm)}
th,td{border-bottom:1px solid var(--line);padding:6px;vertical-align:top}
th{position:sticky;top:0;background:#141a24;z-index:1}

@media (max-width:720px){
  :root{--pad:10px;--radius:10px;--fs:14px;--fs-sm:12px}
  .list-head,.list-row{grid-template-columns:1fr}
  .tabs{gap:4px}
  .btn{padding:6px 8px}
  .sum{padding:3px 6px}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h1>
    <div class="toolbar">
      <span class="badge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="who">‚Äî</strong></span>
      <button class="btn" id="btnChange">–°–º–µ–Ω–∏—Ç—å</button>
      <span class="badge">üíæ –û—Ñ–ª–∞–π–Ω</span>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>
</header>

<main class="wrap" id="app" aria-live="polite"></main>

<!-- –í–•–û–î -->
<div class="login-backdrop" id="loginScreen">
  <div class="login">
    <h2 style="margin:0 0 8px;font-size:18px">–í—Ö–æ–¥</h2>
    <div class="grid">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë –∏–º—è
        <select id="userSel" style="margin-top:6px"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>
      </label>

      <div id="codeRow" style="display:none">
        <div class="notice">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥.</div>
        <label>–ö–æ–¥
          <input id="codeInp" inputmode="numeric" maxlength="4" placeholder="____" style="margin-top:6px" />
        </label>
      </div>

      <button class="btn primary" id="loginGo">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <div id="firstRunHint" class="notice" style="display:none">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–º–µ–Ω–∞.</div>
    </div>
  </div>
</div>

<script>
/* ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ (IndexedDB + fallback) ===== */
const idb=(function(){
  const DB='invMobile_v1', V=1; let dbp=null;
  function open(){ if(dbp) return dbp; dbp=new Promise((res,rej)=>{
    const r=indexedDB.open(DB,V);
    r.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'id'});
      if(!db.objectStoreNames.contains('items')) db.createObjectStore('items',{keyPath:'id'});
      if(!db.objectStoreNames.contains('assign')) db.createObjectStore('assign',{keyPath:'itemId'});
      if(!db.objectStoreNames.contains('entries')) db.createObjectStore('entries',{keyPath:'key'});
      if(!db.objectStoreNames.contains('snaps')) db.createObjectStore('snaps',{keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  }); return dbp;}
  async function rw(mode,store){const db=await open();return db.transaction([store],mode).objectStore(store)}
  const LS='inv_fb_mobile', read=()=>{try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}}}, write=o=>localStorage.setItem(LS,JSON.stringify(o));
  async function tryCall(fn){try{return await fn()}catch{return{__fb:true}}}
  return{
    async set(s,v){const r=await tryCall(async()=>{const o=await rw('readwrite',s);await new Promise((res,rej)=>{const q=o.put(v);q.onsuccess=res;q.onerror=()=>rej(q.error)});return v}); if(r&&r.__fb){const db=read();(db[s]??={})[v.id||v.key]=v;write(db)}return v},
    async get(s,k){const r=await tryCall(async()=>{const o=await rw('readonly',s);return await new Promise((res,rej)=>{const q=o.get(k);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read();return db[s]?.[k]} return r},
    async all(s){const r=await tryCall(async()=>{const o=await rw('readonly',s);return await new Promise((res,rej)=>{const q=o.getAll();q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read();return Object.values(db[s]||{})} return r},
    async del(s,k){const r=await tryCall(async()=>{const o=await rw('readwrite',s);return await new Promise((res,rej)=>{const q=o.delete(k);q.onsuccess=res;q.onerror=()=>rej(q.error)})}); if(r&&r.__fb){const db=read(); if(db[s]) delete db[s][k]; write(db)}}
  }
})();

/* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / —É—Ç–∏–ª–∏—Ç—ã / —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
const RESPONSIBLE_CODE='5878';
const uid=(p='id')=>`${p}_${Math.random().toString(36).slice(2,7)}${Date.now().toString(36)}`;
const now=()=>new Date().toISOString();
const sum=xs=>(xs||[]).reduce((a,b)=>a+(+b.value||0),0);
const byOrder=(a,b)=>(a.order||0)-(b.order||0);
const state={user:null,tabs:[], _loginTimer:null};
const ALWAYS_ASK_LOGIN=true; // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

/* ===== –î–∞–Ω–Ω—ã–µ ===== */
async function ensureSeed(){
  const users=await idb.all('users');
  if(!users.length){
    await idb.set('users',{id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible',active:true,createdAt:now()});
  }
}
async function listUsers(){ return (await idb.all('users')).filter(u=>u.active!==false).sort((a,b)=>a.name.localeCompare(b.name,'ru')) }
async function listItems(){ return (await idb.all('items')).sort(byOrder) }
async function getAssign(){ const a=await idb.all('assign'); return new Map(a.map(x=>[x.itemId,x.userId])) }
async function setAssign(itemId,userId){ await idb.set('assign',{itemId,userId}) }
async function getEntry(userId,itemId){ return await idb.get('entries',`${userId}|${itemId}`) || {key:`${userId}|${itemId}`,userId,itemId,values:[],comment:''} }
async function setEntry(e){ await idb.set('entries',e) }
async function allEntries(){ return await idb.all('entries') }
async function clearCurrent(){ for(const e of await idb.all('entries')) await idb.del('entries',e.key) }
async function makeSnap(title,byUser){
  const items=await listItems(), users=await listUsers(), ent=await allEntries(), totals={};
  for(const it of items){
    const byU={}; for(const u of users){ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); byU[u.id]=e?sum(e.values):0 }
    totals[it.id]={overall:Object.values(byU).reduce((a,b)=>a+b,0),byUser:byU};
  }
  const snap={id:uid('snap'),title,createdAt:now(),createdBy:byUser.id,totals,items,users,comments:[]};
  await idb.set('snaps',snap); return snap;
}
async function listSnaps(){ const s=await idb.all('snaps'); return s.sort((a,b)=>a.createdAt>b.createdAt?-1:1) }

/* ===== –í–∫–ª–∞–¥–∫–∏ ===== */
function setTabs(){
  const isResp=state.user?.role==='responsible';
  state.tabs=[{id:'mine',label:'–ú–æ—è —á–∞—Å—Ç—å'}, ...(isResp?[{id:'total',label:'–ò—Ç–æ–≥'},{id:'manage',label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏'}]:[]), {id:'history',label:'–ò—Å—Ç–æ—Ä–∏—è'}];
}
function drawTabs(){
  const bar=document.getElementById('tabs'); bar.innerHTML='';
  const current=location.hash.slice(1)||state.tabs[0]?.id;
  for(const t of state.tabs){
    const b=document.createElement('button'); b.className='tab'+(current===t.id?' active':''); b.textContent=t.label;
    b.onclick=()=>{location.hash=t.id; render()}; bar.appendChild(b);
  }
}

/* ===== –í—Ö–æ–¥ ===== */
async function fillUsersIntoSelect(){
  const sel=document.getElementById('userSel'); if(!sel) return;
  const prev=sel.value;
  sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`;
  const users=await listUsers();
  for(const u of users){
    const opt=document.createElement('option');
    opt.value=u.id; opt.textContent=u.name+(u.role==='responsible'?' (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)':'');
    opt.dataset.role=u.role; sel.appendChild(opt);
  }
  if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
  const noUsers = sel.options.length<=1;
  document.getElementById('codeRow').style.display = (sel.selectedOptions[0]?.dataset.role==='responsible' || noUsers) ? 'block' : 'none';
  document.getElementById('firstRunHint').style.display = noUsers ? 'block':'none';
}
document.getElementById('userSel').addEventListener('change',()=>fillUsersIntoSelect());

document.getElementById('loginGo').onclick=async()=>{
  const sel=document.getElementById('userSel');
  const users=await listUsers();
  let picked=null;

  if(sel.value){
    picked = users.find(u=>u.id===sel.value);
    if(!picked) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    if(picked.role==='responsible'){
      const code=(document.getElementById('codeInp').value||'').trim();
      if(code!==RESPONSIBLE_CODE) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    }
  } else {
    // –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ ‚Äî –¥–æ–ø—É—Å–∫–∞–µ–º –≤—Ö–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ø–æ –∫–æ–¥—É
    const code=(document.getElementById('codeInp').value||'').trim();
    if(code!==RESPONSIBLE_CODE) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    picked = users.find(u=>u.role==='responsible') || {id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible',active:true,createdAt:now()};
    await idb.set('users',picked);
  }

  state.user=picked;
  localStorage.setItem('inv_user',JSON.stringify(state.user));
  stopLoginAutoRefresh();
  document.getElementById('loginScreen').style.display='none';
  render();
};

document.getElementById('btnChange').onclick=async()=>{
  localStorage.removeItem('inv_user');
  await fillUsersIntoSelect();
  document.getElementById('codeInp').value='';
  document.getElementById('loginScreen').style.display='';
  startLoginAutoRefresh();
};

function startLoginAutoRefresh(){ stopLoginAutoRefresh(); state._loginTimer=setInterval(fillUsersIntoSelect,2000) }
function stopLoginAutoRefresh(){ if(state._loginTimer){clearInterval(state._loginTimer); state._loginTimer=null} }

/* ===== –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ===== */
async function viewMine(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const assigns=await getAssign(); const ent=await allEntries();
  const hasAssign=(await idb.all('assign')).length>0;
  const myId=state.user.id;
  const list=hasAssign ? items.filter(i=>assigns.get(i.id)===myId) : items;

  app.appendChild(el(`<div class="notice card">${hasAssign?`–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <b>${list.length}</b>.`:`–†–∞–∑–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤–∏–¥–Ω—ã –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏: <b>${items.length}</b>.`}</div>`));

  const box=el(`<div class="card">
    <div class="list-head"><div>‚Ññ</div><div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –æ–ø–∏—Å–∞–Ω–∏–µ</div><div>–í–≤–æ–¥</div></div>
    <div id="rows"></div>
  </div>`); app.appendChild(box);
  const rows=box.querySelector('#rows');

  for(const it of list){
    const e=ent.find(x=>x.userId===myId && x.itemId===it.id) || {key:`${myId}|${it.id}`,userId:myId,itemId:it.id,values:[],comment:''};
    const total=sum(e.values);
    const row=el(`<div class="list-row">
      <div>#${it.order||''}</div>
      <div>
        <div style="font-weight:600">${it.name||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}</div>
        <div class="pills" id="vals_${it.id}">
          ${e.values.map(v=>`<span class="pill" data-vid="${v.id}">${v.value}<button class="btn ghost" data-e="edit" title="–ò–∑–º.">‚úèÔ∏è</button><button class="btn ghost" data-e="del" title="–£–¥.">üóëÔ∏è</button></span>`).join('')}
        </div>
        <textarea id="c_${it.id}" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" style="margin-top:6px">${e.comment||''}</textarea>
        <div class="grid" style="grid-template-columns:1fr auto auto;gap:6px;margin-top:6px">
          <input type="number" step="1" inputmode="numeric" id="n_${it.id}" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ">
          <button class="btn primary" data-add="${it.id}">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" data-reset="${it.id}">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div class="sum" style="margin-top:6px">–ò—Ç–æ–≥–æ: <span class="v" id="s_${it.id}">${total}</span></div>
        <div class="grid" style="grid-template-columns:auto 1fr;align-items:center;margin-top:6px">
          <span>üí¨</span><button class="btn" data-savec="${it.id}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </div>
      </div>
    </div>`);
    rows.appendChild(row);

    row.querySelector(`[data-add="${it.id}"]`).onclick=async()=>{
      const v=parseFloat(row.querySelector(`#n_${it.id}`).value);
      if(isNaN(v)) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
      e.values.push({id:uid('v'),value:v,ts:now()}); await setEntry(e); render();
    };
    row.querySelector(`[data-reset="${it.id}"]`).onclick=async()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏?'))return;
      e.values=[]; await setEntry(e); render();
    };
    row.querySelector(`[data-savec="${it.id}"]`).onclick=async()=>{
      e.comment=row.querySelector(`#c_${it.id}`).value; await setEntry(e);
    };
    row.querySelectorAll(`#vals_${it.id} .pill`).forEach(p=>{
      const vid=p.getAttribute('data-vid');
      p.querySelector('[data-e="del"]').onclick=async()=>{ e.values=e.values.filter(x=>x.id!==vid); await setEntry(e); render(); };
      p.querySelector('[data-e="edit"]').onclick=async()=>{
        const found=e.values.find(x=>x.id===vid); const nv=prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',found.value);
        if(nv===null) return; const n=parseFloat(nv); if(isNaN(n)) return;
        found.value=n; await setEntry(e); render();
      };
    });
  }
}

async function viewTotal(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const users=await listUsers(); const ent=await allEntries(); const assigns=await getAssign();
  const tbl=el(`<div class="card" style="overflow:auto">
    <table><thead><tr>
      <th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th><th>–ù–∞–∑–Ω–∞—á–µ–Ω–æ</th>
    </tr></thead><tbody id="tb"></tbody></table>
  </div>`); app.appendChild(tbl);
  const tb=tbl.querySelector('#tb');
  for(const it of items){
    const row=el(`<tr>
      <td>${it.order||''}</td>
      <td>${it.name||''}</td>
      ${users.map(u=>{ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); return `<td>${e?sum(e.values):0}</td>`; }).join('')}
      <td><b>${ users.map(u=>{const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id);return e?sum(e.values):0}).reduce((a,b)=>a+b,0) }</b></td>
      <td><select data-assign="${it.id}">${users.map(u=>`<option value="${u.id}" ${assigns.get(it.id)===u.id?'selected':''}>${u.name}</option>`).join('')}</select></td>
    </tr>`);
    tb.appendChild(row);
    row.querySelector(`[data-assign="${it.id}"]`).onchange=async e=>{ await setAssign(it.id,e.target.value) };
  }

  const tools=el(`<div class="card grid" style="grid-template-columns:1fr auto;align-items:end">
    <div>
      <h3 style="margin:0 0 6px;font-size:15px">–†–∞–∑–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</h3>
      <div class="grid" style="grid-template-columns:110px auto;gap:6px">
        <input id="splitN" type="number" min="1" step="1" value="2">
        <button class="btn primary" id="doSplit">–†–∞–∑–¥–µ–ª–∏—Ç—å</button>
      </div>
      <div class="notice" style="margin-top:6px">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤ —Å—Ç–æ–ª–±—Ü–µ ¬´–ù–∞–∑–Ω–∞—á–µ–Ω–æ¬ª.</div>
    </div>
    <div class="grid" style="grid-auto-flow:column;gap:6px">
      <button class="btn primary" id="snap">–ó–∞–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é</button>
      <button class="btn" id="clear">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é</button>
    </div>
  </div>`); app.appendChild(tools);

  tools.querySelector('#doSplit').onclick=async()=>{
    const n=Math.max(1,parseInt(tools.querySelector('#splitN').value||'1',10));
    const arr=items.slice().sort(byOrder); const members=(await listUsers());
    if(members.length<n){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); return }
    const chunk=Math.ceil(arr.length/n);
    for(let i=0;i<n;i++){ for(const it of arr.slice(i*chunk,(i+1)*chunk)){ await setAssign(it.id,members[i].id) } }
    render();
  };
  tools.querySelector('#snap').onclick=async()=>{
    const title=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–≤–≥—É—Å—Ç 2025):'); if(!title) return;
    await makeSnap(title,state.user); alert('–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    location.hash='#history'; render();
  };
  tools.querySelector('#clear').onclick=async()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é? –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —Ç—Ä–æ–Ω–µ—Ç—Å—è.')){ await clearCurrent(); render(); } };
}

async function viewManage(){
  const app=document.getElementById('app'); app.innerHTML='';
  const users=await listUsers();
  const ucard=el(`<div class="card">
    <h3 style="margin:0 0 6px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
    <div id="ulist"></div>
    <div class="grid" style="grid-template-columns:1fr 160px auto;gap:6px;margin-top:6px">
      <input id="newU" placeholder="–ò–º—è">
      <select id="newR"><option value="waiter">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option><option value="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option></select>
      <button class="btn primary" id="addU">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>`); app.appendChild(ucard);
  const UL=ucard.querySelector('#ulist');
  for(const u of users){
    const r=el(`<div class="grid" style="grid-template-columns:1fr 160px auto auto;gap:6px;margin:6px 0">
      <input id="nm_${u.id}" value="${u.name}">
      <select id="rl_${u.id}">
        <option value="waiter" ${u.role==='waiter'?'selected':''}>–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option>
        <option value="responsible" ${u.role==='responsible'?'selected':''}>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
      </select>
      <button class="btn" data-save="${u.id}">üíæ</button>
      <button class="btn" data-hide="${u.id}">–°–∫—Ä—ã—Ç—å</button>
    </div>`); UL.appendChild(r);
    r.querySelector(`[data-save="${u.id}"]`).onclick=async()=>{
      await idb.set('users',{...u,name:r.querySelector(`#nm_${u.id}`).value.trim()||u.name,role:r.querySelector(`#rl_${u.id}`).value});
      if(state.user.id===u.id){ state.user=await idb.get('users',u.id); localStorage.setItem('inv_user',JSON.stringify(state.user)); }
      render();
    };
    r.querySelector(`[data-hide="${u.id}"]`).onclick=async()=>{ await idb.set('users',{...u,active:false}); render(); };
  }
  ucard.querySelector('#addU').onclick=async()=>{
    const name=ucard.querySelector('#newU').value.trim(); if(!name) return alert('–ò–º—è?');
    const role=ucard.querySelector('#newR').value; await idb.set('users',{id:uid('u'),name,role,active:true,createdAt:now()}); render();
  };

  const items=await listItems();
  const icard=el(`<div class="card">
    <h3 style="margin:0 0 6px">–ü–æ–∑–∏—Ü–∏–∏</h3>
    <div id="ilist"></div>
    <div class="grid" style="grid-template-columns:100px 1fr 2fr auto;gap:6px;margin-top:6px">
      <input id="io" type="number" placeholder="‚Ññ">
      <input id="in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <input id="id" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
      <button class="btn primary" id="addI">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>`); app.appendChild(icard);
  const IL=icard.querySelector('#ilist');
  for(const it of items){
    const r=el(`<div class="grid" style="grid-template-columns:100px 1fr 2fr auto auto;gap:6px;margin:6px 0">
      <input id="o_${it.id}" type="number" value="${it.order||0}">
      <input id="n_${it.id}" value="${it.name||''}">
      <input id="d_${it.id}" value="${it.description||''}">
      <button class="btn" data-save="${it.id}">üíæ</button>
      <button class="btn" data-del="${it.id}">üóëÔ∏è</button>
    </div>`); IL.appendChild(r);
    r.querySelector(`[data-save="${it.id}"]`).onclick=async()=>{
      await idb.set('items',{...it,order:parseInt(r.querySelector(`#o_${it.id}`).value||'0',10),name:r.querySelector(`#n_${it.id}`).value.trim(),description:r.querySelector(`#d_${it.id}`).value.trim()});
      render();
    };
    r.querySelector(`[data-del="${it.id}"]`).onclick=async()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')){ await idb.del('items',it.id); render(); } };
  }
  icard.querySelector('#addI').onclick=async()=>{
    const oo=parseInt(icard.querySelector('#io').value||'0',10);
    const nn=icard.querySelector('#in').value.trim(); if(!nn) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ?');
    const dd=icard.querySelector('#id').value.trim();
    await idb.set('items',{id:uid('it'),order:oo,name:nn,description:dd});
    render();
  };
}

async function viewHistory(){
  const app=document.getElementById('app'); app.innerHTML='';
  const snaps=await listSnaps();
  if(!snaps.length){ app.appendChild(el(`<div class="card notice">–°–Ω–∏–º–∫–æ–≤ –Ω–µ—Ç.</div>`)); return }
  for(const s of snaps){
    const card=el(`<div class="card" style="overflow:auto">
      <div><b>${s.title}</b> <span style="color:#9aa3b2">‚Äî ${new Date(s.createdAt).toLocaleString('ru-RU')}</span></div>
      <table style="margin-top:6px"><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${s.users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th></tr></thead>
      <tbody id="tb_${s.id}"></tbody></table>
    </div>`); app.appendChild(card);
    const tb=card.querySelector(`#tb_${s.id}`);
    for(const it of s.items.sort(byOrder)){
      const t=s.totals[it.id]; if(!t) continue;
      tb.appendChild(el(`<tr><td>${it.order||''}</td><td>${it.name||''}</td>${s.users.map(u=>`<td>${t.byUser[u.id]||0}</td>`).join('')}<td><b>${t.overall||0}</b></td></tr>`));
    }
  }
}

/* ===== –•–µ–ª–ø–µ—Ä—ã ===== */
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
async function render(){
  setTabs(); drawTabs();
  document.getElementById('who').textContent=state.user?.name||'‚Äî';
  const hash=location.hash.slice(1)||state.tabs[0].id;
  if(hash==='mine') await viewMine();
  if(hash==='total') await viewTotal();
  if(hash==='manage') await viewManage();
  if(hash==='history') await viewHistory();
}

/* ===== –ó–∞–ø—É—Å–∫ ===== */
(async function boot(){
  await ensureSeed();
  if (ALWAYS_ASK_LOGIN) localStorage.removeItem('inv_user');
  try{ const u=JSON.parse(localStorage.getItem('inv_user')||'null'); if(u&&u.id) state.user=u; }catch{}
  if(!state.user){
    await fillUsersIntoSelect();
    document.getElementById('loginScreen').style.display='';
    startLoginAutoRefresh();
  }else{
    document.getElementById('loginScreen').style.display='none';
    render();
  }
})();
</script>
</body>
</html>
