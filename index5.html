<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="theme-color" content="#0f1115">
<style>
:root{
  --bg:#0f1115; --fg:#e7eaf0; --muted:#9aa3b2; --accent:#6f86ff; --line:#273047;
  --card:#151a22; --ok:#2ecc71; --warn:#ffb400; --err:#ff5c5c; --chip:#20283a; --bright:#ffef5a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f1115,#0f1115cc 60%,#0f111500);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#121726}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:9px;background:#141a28;cursor:pointer}
.tab.active{background:#1a2234;border-color:#30405f}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
.btn{background:#1a2234;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:9px 12px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.warn{background:var(--warn);color:#111;border-color:var(--warn)}
.btn.danger{background:var(--err);color:#fff;border-color:var(--err)}
.btn.ghost{background:transparent}
input,select,textarea{width:100%;background:#111827;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px}
.grid{display:grid;gap:10px}
.list-head, .list-row{display:grid;grid-template-columns:64px 1fr 160px;gap:10px;align-items:start}
.list-head{color:#cfd6e4;font-weight:600}
.sum{display:inline-flex;gap:6px;align-items:center;border:1px dashed #4b536a;background:#1a2234;padding:6px 10px;border-radius:10px}
.sum .v{background:var(--bright);color:#111;padding:2px 8px;border-radius:8px;font-weight:800}
.pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:4px 8px}
.actions{display:flex;flex-wrap:wrap;gap:8px}
.sticky{position:sticky;bottom:0;background:linear-gradient(0deg,#0f1115,#0f111500 70%);padding-top:10px}
.notice{padding:10px;border:1px dashed var(--line);border-radius:12px;color:#c9d2e1;background:#141a22}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
th{position:sticky;top:0;background:#141a24;z-index:1}
.login-backdrop{position:fixed;inset:0;background:#0b0d1288;backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}
.login{width:min(520px,94vw);background:#111521;border:1px solid var(--line);border-radius:16px;padding:18px}
@media(max-width:860px){
  .list-head,.list-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
    <div class="toolbar">
      <span class="badge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="who">‚Äî</strong></span>
      <button class="btn" id="btnChange">–°–º–µ–Ω–∏—Ç—å</button>
      <span class="badge">üíæ –û—Ñ–ª–∞–π–Ω</span>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>
</header>

<main class="wrap" id="app" aria-live="polite"></main>

<!-- –í–•–û–î -->
<div class="login-backdrop" id="loginScreen">
  <div class="login">
    <h2 style="margin:0 0 12px">–í—Ö–æ–¥</h2>
    <div class="grid">
      <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        <select id="roleSel" style="margin-top:6px"
          onchange="document.getElementById('codeRow').style.display=(this.value==='responsible'?'block':'none')">
          <option value="waiter">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option>
          <option value="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
        </select>
      </label>
      <div id="codeRow" style="display:none">
        <label>–ö–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
          <input id="codeInp" inputmode="numeric" maxlength="2" placeholder="__" style="margin-top:6px">
        </label>
      </div>
      <button class="btn primary" id="loginGo">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <div class="notice">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Ç–æ–≥—É: <b style="color:var(--bright)">58</b>.</div>
    </div>
  </div>
</div>

<script>
/* ====== –ø—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ: IndexedDB —Å —Ñ–æ–ª–±—ç–∫–æ–º –≤ localStorage ====== */
const idb=(function(){
  const DB='invCleanDBv1', V=1; let dbp=null;
  function open(){ if(dbp) return dbp;
    dbp=new Promise((res,rej)=>{
      const r=indexedDB.open(DB,V);
      r.onupgradeneeded=e=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'id'});
        if(!db.objectStoreNames.contains('items')) db.createObjectStore('items',{keyPath:'id'});
        if(!db.objectStoreNames.contains('assign')) db.createObjectStore('assign',{keyPath:'itemId'});
        if(!db.objectStoreNames.contains('entries')) db.createObjectStore('entries',{keyPath:'key'});
        if(!db.objectStoreNames.contains('snaps')) db.createObjectStore('snaps',{keyPath:'id'});
      };
      r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
    }); return dbp;
  }
  async function rw(mode,store){ const db=await open(); return db.transaction([store],mode).objectStore(store); }
  const LS='inv_fallback';
  const readLS=()=>{try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch(_){return{}}}
  const writeLS=o=>localStorage.setItem(LS,JSON.stringify(o));
  async function tryCall(fn){ try{return await fn()}catch(e){return{__fb:true,e}} }
  return {
    async set(store,val){ const r=await tryCall(async()=>{const s=await rw('readwrite',store); await new Promise((res,rej)=>{const q=s.put(val); q.onsuccess=res;q.onerror=()=>rej(q.error)}); return val;});
      if(r&&r.__fb){ const db=readLS(); (db[store]??={})[val.id||val.key]=val; writeLS(db); return val }
      return r;
    },
    async get(store,key){ const r=await tryCall(async()=>{const s=await rw('readonly',store); return await new Promise((res,rej)=>{const q=s.get(key); q.onsuccess=()=>res(q.result); q.onerror=()=>rej(q.error)})});
      if(r&&r.__fb){ const db=readLS(); return db[store]?.[key] }
      return r;
    },
    async all(store){ const r=await tryCall(async()=>{const s=await rw('readonly',store); return await new Promise((res,rej)=>{const q=s.getAll(); q.onsuccess=()=>res(q.result||[]); q.onerror=()=>rej(q.error)})});
      if(r&&r.__fb){ const db=readLS(); return Object.values(db[store]||{}) }
      return r;
    },
    async del(store,key){ const r=await tryCall(async()=>{const s=await rw('readwrite',store); return await new Promise((res,rej)=>{const q=s.delete(key); q.onsuccess=res;q.onerror=()=>rej(q.error)})});
      if(r&&r.__fb){ const db=readLS(); if(db[store]) delete db[store][key]; writeLS(db); }
      return r;
    }
  }
})();

/* ====== —É—Ç–∏–ª–∏—Ç—ã/—Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
const RESPONSIBLE_CODE='58';
const uid=(p='id')=>`${p}_${Math.random().toString(36).slice(2,7)}${Date.now().toString(36)}`;
const now=()=>new Date().toISOString();
const sum=arr=>(arr||[]).reduce((a,b)=>a+(+b.value||0),0);
const byOrder=(a,b)=>(a.order||0)-(b.order||0);
const state={user:null,tabs:[]};

/* ====== –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ====== */
async function ensureSeed(){
  const u=await idb.all('users');
  if(!u.length){
    await idb.set('users',{id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible',active:true,createdAt:now()});
    await idb.set('users',{id:'u_waiter',name:'–û—Ñ–∏—Ü–∏–∞–Ω—Ç',role:'waiter',active:true,createdAt:now()});
  }
}
async function listUsers(){ return (await idb.all('users')).filter(u=>u.active!==false).sort((a,b)=>a.name.localeCompare(b.name,'ru')) }
async function listItems(){ return (await idb.all('items')).sort(byOrder) }
async function getAssign(){ const a=await idb.all('assign'); return new Map(a.map(x=>[x.itemId,x.userId])) }
async function setAssign(itemId,userId){ await idb.set('assign',{itemId,userId}) }
async function getEntry(userId,itemId){
  return await idb.get('entries',`${userId}|${itemId}`) || {key:`${userId}|${itemId}`,userId,itemId,values:[],comment:''}
}
async function setEntry(e){ await idb.set('entries',e) }
async function allEntries(){ return await idb.all('entries') }
async function clearCurrent(){ for(const e of await idb.all('entries')) await idb.del('entries',e.key) }
async function makeSnap(title,byUser){
  const items=await listItems(); const users=await listUsers(); const ent=await allEntries(); const totals={};
  for(const it of items){
    const byU={}; for(const u of users){ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); byU[u.id]=e?sum(e.values):0 }
    totals[it.id]={overall:Object.values(byU).reduce((a,b)=>a+b,0),byUser:byU};
  }
  const snap={id:uid('snap'),title,createdAt:now(),createdBy:byUser.id,totals,items,users,comments:[]};
  await idb.set('snaps',snap); return snap;
}
async function listSnaps(){ const s=await idb.all('snaps'); return s.sort((a,b)=>a.createdAt>b.createdAt?-1:1) }

/* ====== UI: –≤–∫–ª–∞–¥–∫–∏ ====== */
function setTabs(){
  const isResp=state.user?.role==='responsible';
  state.tabs=[
    {id:'mine',label:'–ú–æ—è —á–∞—Å—Ç—å'},
    ...(isResp?[{id:'total',label:'–ò—Ç–æ–≥'},{id:'manage',label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏'}]:[]),
    {id:'history',label:'–ò—Å—Ç–æ—Ä–∏—è'}
  ];
}
function drawTabs(){
  const bar=document.getElementById('tabs'); bar.innerHTML='';
  const current=location.hash.slice(1)||state.tabs[0]?.id;
  for(const t of state.tabs){
    const b=document.createElement('button'); b.className='tab'+(current===t.id?' active':''); b.textContent=t.label;
    b.onclick=()=>{location.hash=t.id; render()}; bar.appendChild(b);
  }
}

/* ====== –í—Ö–æ–¥ ====== */
document.getElementById('loginGo').onclick=async()=>{
  const role=document.getElementById('roleSel').value;
  const code=(document.getElementById('codeInp').value||'').trim();
  if(role==='responsible' && code!==RESPONSIBLE_CODE){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'); return }
  state.user = role==='responsible'
    ? {id:'u_resp',name:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',role:'responsible'}
    : {id:'u_waiter',name:'–û—Ñ–∏—Ü–∏–∞–Ω—Ç',role:'waiter'};
  localStorage.setItem('inv_user',JSON.stringify(state.user));
  document.getElementById('loginScreen').style.display='none';
  render();
};
document.getElementById('btnChange').onclick=()=>{
  localStorage.removeItem('inv_user');
  document.getElementById('loginScreen').style.display='';
};

/* ====== –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ====== */
async function viewMine(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const assigns=await getAssign(); const ent=await allEntries();
  const hasAssign=(await idb.all('assign')).length>0;
  const myId=state.user.id;
  const list=hasAssign ? items.filter(i=>assigns.get(i.id)===myId) : items;

  app.appendChild(el(`<div class="notice card">${hasAssign?`–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <b>${list.length}</b>.`:`–†–∞–∑–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤–∏–¥–Ω—ã –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏: <b>${items.length}</b>.`}</div>`));

  const box=el(`<div class="card">
    <div class="list-head"><div>‚Ññ</div><div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –æ–ø–∏—Å–∞–Ω–∏–µ</div><div>–í–≤–æ–¥</div></div>
    <div id="rows"></div>
    <div class="sticky actions" style="justify-content:flex-end">
      <button class="btn" id="wa">WhatsApp</button>
      <button class="btn" id="txt">TXT</button>
      <button class="btn" id="xls">Excel</button>
    </div>
  </div>`); app.appendChild(box);
  const rows=box.querySelector('#rows');

  for(const it of list){
    const e=ent.find(x=>x.userId===myId && x.itemId===it.id) || {key:`${myId}|${it.id}`,userId:myId,itemId:it.id,values:[],comment:''};
    const total=sum(e.values);
    const row=el(`<div class="list-row">
      <div>#${it.order||''}</div>
      <div>
        <div style="font-weight:600">${it.name||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}</div>
        <div class="muted" style="font-size:14px">${it.description||''}</div>
        <div class="pills" id="vals_${it.id}">
          ${e.values.map(v=>`<span class="pill" data-vid="${v.id}">${v.value}
            <button class="btn ghost" data-e="edit" title="–ò–∑–º.">‚úèÔ∏è</button>
            <button class="btn ghost" data-e="del" title="–£–¥.">üóëÔ∏è</button>
          </span>`).join('')}
        </div>
        <textarea id="c_${it.id}" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" style="margin-top:6px">${e.comment||''}</textarea>
        <div class="actions" style="justify-content:flex-end;margin-top:6px">
          <button class="btn" data-savec="${it.id}">üí¨ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </div>
      </div>
      <div>
        <div class="actions">
          <input type="number" step="1" inputmode="numeric" id="n_${it.id}" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ">
          <button class="btn primary" data-add="${it.id}">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" data-reset="${it.id}">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div class="sum" style="margin-top:8px">–ò—Ç–æ–≥–æ: <span class="v" id="s_${it.id}">${total}</span></div>
      </div>
    </div>`);
    rows.appendChild(row);

    row.querySelector(`[data-add="${it.id}"]`).onclick=async()=>{
      const v=parseFloat(row.querySelector(`#n_${it.id}`).value);
      if(isNaN(v)) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
      e.values.push({id:uid('v'),value:v,ts:now()}); await setEntry(e); render();
    };
    row.querySelector(`[data-reset="${it.id}"]`).onclick=async()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏?'))return;
      e.values=[]; await setEntry(e); render();
    };
    row.querySelector(`[data-savec="${it.id}"]`).onclick=async()=>{
      e.comment=row.querySelector(`#c_${it.id}`).value; await setEntry(e);
    };
    row.querySelectorAll(`#vals_${it.id} .pill`).forEach(p=>{
      const vid=p.getAttribute('data-vid');
      p.querySelector('[data-e="del"]').onclick=async()=>{ e.values=e.values.filter(x=>x.id!==vid); await setEntry(e); render(); };
      p.querySelector('[data-e="edit"]').onclick=async()=>{
        const found=e.values.find(x=>x.id===vid); const nv=prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',found.value);
        if(nv===null) return; const n=parseFloat(nv); if(isNaN(n)) return;
        found.value=n; await setEntry(e); render();
      };
    });
  }

  box.querySelector('#wa').onclick=async()=>{
    const text=await buildMyText(list,myId); window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,'_blank');
  };
  box.querySelector('#txt').onclick=async()=>download('my.txt',(await buildMyLines(list,myId)).join('\n'),'text/plain');
  box.querySelector('#xls').onclick=async()=>download('my.xls',toXLS(await buildMyRows(list,myId)),'application/vnd.ms-excel');
}
async function buildMyRows(list,myId){
  const rows=[]; for(const it of list){ const e=await getEntry(myId,it.id); rows.push([it.order||'',it.name||'',(e?sum(e.values):0), (e?.comment||'').replace(/\n/g,' ')]) } return rows;
}
async function buildMyLines(list,myId){
  const rows=await buildMyRows(list,myId); return rows.map(r=>`${r[0]} ‚Äî ${r[1]} | –ò—Ç–æ–≥–æ: ${r[2]} | ${r[3]}`);
}
async function buildMyText(list,myId){ return ['–ú–æ—è —á–∞—Å—Ç—å:',...(await buildMyLines(list,myId))].join('\n') }

async function viewTotal(){
  const app=document.getElementById('app'); app.innerHTML='';
  const items=await listItems(); const users=await listUsers(); const ent=await allEntries(); const assigns=await getAssign();
  const tbl=el(`<div class="card" style="overflow:auto">
    <table><thead><tr>
      <th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th><th>–ù–∞–∑–Ω–∞—á–µ–Ω–æ</th>
    </tr></thead><tbody id="tb"></tbody></table>
  </div>`); app.appendChild(tbl);
  const tb=tbl.querySelector('#tb');
  for(const it of items){
    const row=el(`<tr>
      <td>${it.order||''}</td>
      <td><div style="font-weight:600">${it.name||''}</div><div class="muted" style="font-size:12px">${it.description||''}</div></td>
      ${users.map(u=>{
        const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); return `<td>${e?sum(e.values):0}</td>`;
      }).join('')}
      <td><b>${
        users.map(u=>{const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id);return e?sum(e.values):0}).reduce((a,b)=>a+b,0)
      }</b></td>
      <td><select data-assign="${it.id}">${users.map(u=>`<option value="${u.id}" ${assigns.get(it.id)===u.id?'selected':''}>${u.name}</option>`).join('')}</select></td>
    </tr>`);
    tb.appendChild(row);
    row.querySelector(`[data-assign="${it.id}"]`).onchange=async e=>{ await setAssign(it.id,e.target.value) };
  }

  const split=el(`<div class="card grid" style="grid-template-columns:1fr 1fr">
    <div>
      <h3 style="margin:0 0 8px">–†–∞–∑–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</h3>
      <div class="actions">
        <input id="splitN" type="number" min="1" step="1" value="2" style="max-width:130px">
        <button class="btn primary" id="doSplit">–†–∞–∑–¥–µ–ª–∏—Ç—å</button>
      </div>
      <div class="muted" style="margin-top:6px">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –≤ —Å—Ç–æ–ª–±—Ü–µ ¬´–ù–∞–∑–Ω–∞—á–µ–Ω–æ¬ª.</div>
    </div>
    <div class="actions" style="justify-content:flex-end;align-items:end">
      <button class="btn" id="wa">WhatsApp (–∏—Ç–æ–≥)</button>
      <button class="btn" id="txt">TXT</button>
      <button class="btn" id="xls">Excel</button>
      <button class="btn primary" id="snap">–ó–∞–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é</button>
      <button class="btn danger" id="clear">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é</button>
    </div>
  </div>`); app.appendChild(split);

  split.querySelector('#doSplit').onclick=async()=>{
    const n=Math.max(1,parseInt(split.querySelector('#splitN').value||'1',10));
    const arr=items.slice().sort(byOrder); const members=(await listUsers());
    if(members.length<n){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); return }
    const chunk=Math.ceil(arr.length/n);
    for(let i=0;i<n;i++){ for(const it of arr.slice(i*chunk,(i+1)*chunk)){ await setAssign(it.id,members[i].id) } }
    render();
  };
  split.querySelector('#wa').onclick=async()=>window.open(`https://wa.me/?text=${encodeURIComponent(await totalText())}`,'_blank');
  split.querySelector('#txt').onclick=async()=>download('total.txt',(await totalLines()).join('\n'),'text/plain');
  split.querySelector('#xls').onclick=async()=>download('total.xls',toXLS(await totalRows()),'application/vnd.ms-excel');
  split.querySelector('#snap').onclick=async()=>{
    const title=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–≤–≥—É—Å—Ç 2025):'); if(!title) return;
    await makeSnap(title,state.user); alert('–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –û–Ω –Ω–µ–∏–∑–º–µ–Ω—è–µ–º.');
    location.hash='#history'; render();
  };
  split.querySelector('#clear').onclick=async()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é? –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —Ç—Ä–æ–Ω–µ—Ç—Å—è.')){ await clearCurrent(); render(); } };

  async function totalRows(){
    const users=await listUsers(); const items=await listItems(); const ent=await allEntries();
    const rows=[]; for(const it of items){
      const line=[it.order||'',it.name||'']; for(const u of users){ const e=ent.find(x=>x.itemId===it.id&&x.userId===u.id); line.push(e?sum(e.values):0) }
      line.push(line.slice(2).reduce((a,b)=>a+Number(b),0)); rows.push(line);
    } return {rows,headers:['‚Ññ','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',...users.map(u=>u.name),'–ò—Ç–æ–≥–æ']};
  }
  async function totalLines(){ const {rows,headers}=await totalRows(); return [headers.join(' | '),...rows.map(r=>r.join(' | '))] }
  async function totalText(){ return ['–ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è:',...(await totalLines())].join('\n') }
}

async function viewManage(){
  const app=document.getElementById('app'); app.innerHTML='';
  const users=await listUsers();
  const ucard=el(`<div class="card">
    <h3 style="margin:0 0 8px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
    <div id="ulist"></div>
    <div class="actions" style="margin-top:8px">
      <input id="newU" placeholder="–ò–º—è">
      <select id="newR" style="max-width:180px"><option value="waiter">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option><option value="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option></select>
      <button class="btn primary" id="addU">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>`); app.appendChild(ucard);
  const UL=ucard.querySelector('#ulist');
  for(const u of users){
    const r=el(`<div class="actions" style="gap:8px;margin:6px 0">
      <input id="nm_${u.id}" value="${u.name}" style="flex:1">
      <select id="rl_${u.id}" style="max-width:180px">
        <option value="waiter" ${u.role==='waiter'?'selected':''}>–û—Ñ–∏—Ü–∏–∞–Ω—Ç</option>
        <option value="responsible" ${u.role==='responsible'?'selected':''}>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
      </select>
      <button class="btn" data-save="${u.id}">üíæ</button>
      <button class="btn ghost" data-hide="${u.id}">–°–∫—Ä—ã—Ç—å</button>
    </div>`); UL.appendChild(r);
    r.querySelector(`[data-save="${u.id}"]`).onclick=async()=>{
      await idb.set('users',{...u,name:r.querySelector(`#nm_${u.id}`).value.trim()||u.name,role:r.querySelector(`#rl_${u.id}`).value});
      if(state.user.id===u.id){ state.user=await idb.get('users',u.id); localStorage.setItem('inv_user',JSON.stringify(state.user)); }
      render();
    };
    r.querySelector(`[data-hide="${u.id}"]`).onclick=async()=>{ await idb.set('users',{...u,active:false}); render(); };
  }
  ucard.querySelector('#addU').onclick=async()=>{
    const name=ucard.querySelector('#newU').value.trim(); if(!name) return alert('–ò–º—è?');
    const role=ucard.querySelector('#newR').value; await idb.set('users',{id:uid('u'),name,role,active:true,createdAt:now()}); render();
  };

  const items=await listItems();
  const icard=el(`<div class="card">
    <h3 style="margin:0 0 8px">–ü–æ–∑–∏—Ü–∏–∏</h3>
    <div id="ilist"></div>
    <div class="actions" style="margin-top:8px;flex-wrap:wrap">
      <input id="io" type="number" placeholder="‚Ññ" style="max-width:120px">
      <input id="in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1">
      <input id="id" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="flex:2">
      <button class="btn primary" id="addI">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
    </div>
  </div>`); app.appendChild(icard);
  const IL=icard.querySelector('#ilist');
  for(const it of items){
    const r=el(`<div class="actions" style="gap:8px;margin:6px 0;flex-wrap:wrap">
      <input id="o_${it.id}" type="number" value="${it.order||0}" style="max-width:120px">
      <input id="n_${it.id}" value="${it.name||''}" style="flex:1">
      <input id="d_${it.id}" value="${it.description||''}" style="flex:2">
      <button class="btn" data-save="${it.id}">üíæ</button>
      <button class="btn ghost" data-del="${it.id}">üóëÔ∏è</button>
    </div>`); IL.appendChild(r);
    r.querySelector(`[data-save="${it.id}"]`).onclick=async()=>{
      await idb.set('items',{...it,order:parseInt(r.querySelector(`#o_${it.id}`).value||'0',10),name:r.querySelector(`#n_${it.id}`).value.trim(),description:r.querySelector(`#d_${it.id}`).value.trim()});
      render();
    };
    r.querySelector(`[data-del="${it.id}"]`).onclick=async()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')){ await idb.del('items',it.id); render(); } };
  }
  icard.querySelector('#addI').onclick=async()=>{
    const oo=parseInt(icard.querySelector('#io').value||'0',10);
    const nn=icard.querySelector('#in').value.trim(); if(!nn) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ?');
    const dd=icard.querySelector('#id').value.trim();
    await idb.set('items',{id:uid('it'),order:oo,name:nn,description:dd});
    render();
  };
}

async function viewHistory(){
  const app=document.getElementById('app'); app.innerHTML='';
  const snaps=await listSnaps();
  if(!snaps.length){ app.appendChild(el(`<div class="card notice">–°–Ω–∏–º–∫–æ–≤ –Ω–µ—Ç.</div>`)); return }
  for(const s of snaps){
    const card=el(`<div class="card">
      <div class="actions" style="justify-content:space-between">
        <div><b>${s.title}</b> <span class="muted">‚Äî ${new Date(s.createdAt).toLocaleString('ru-RU')}</span></div>
        <span class="badge">–ù–µ–∑—ã–±–ª–µ–º–æ</span>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>${s.users.map(u=>`<th>${u.name}</th>`).join('')}<th>–ò—Ç–æ–≥–æ</th></tr></thead>
        <tbody id="tb_${s.id}"></tbody></table>
      </div>
      <div class="grid" style="margin-top:8px">
        <textarea id="cm_${s.id}" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶"></textarea>
        <div class="actions" style="justify-content:flex-end"><button class="btn" data-addc="${s.id}">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button></div>
        <div id="cl_${s.id}"></div>
      </div>
    </div>`); app.appendChild(card);
    const tb=card.querySelector(`#tb_${s.id}`);
    for(const it of s.items.sort(byOrder)){
      const t=s.totals[it.id]; if(!t) continue;
      tb.appendChild(el(`<tr><td>${it.order||''}</td><td>${it.name||''}</td>${s.users.map(u=>`<td>${t.byUser[u.id]||0}</td>`).join('')}<td><b>${t.overall||0}</b></td></tr>`));
    }
    const clog=card.querySelector(`#cl_${s.id}`);
    const drawC=()=>clog.innerHTML=s.comments.map(c=>`<div class="notice" style="margin:4px 0"><b>${(s.users.find(u=>u.id===c.userId)||{}).name||'‚Äî'}</b>: ${c.text}</div>`).join('');
    drawC();
    card.querySelector(`[data-addc="${s.id}"]`).onclick=async()=>{
      const txt=card.querySelector(`#cm_${s.id}`).value.trim(); if(!txt) return;
      s.comments.push({userId:state.user.id,text:txt,ts:now()}); await idb.set('snaps',s); drawC(); card.querySelector(`#cm_${s.id}`).value='';
    };
  }
}

/* ====== helpers ====== */
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }
function download(name,content,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000) }
function toXLS(data){ const rows=(data.headers?[data.headers]:[]).concat(data.rows||[]); const xmlHead=`<?xml version="1.0"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å"><Table>`; const body=rows.map(r=>`<Row>${r.map(c=>`<Cell><Data ss:Type="String">${String(c).replace(/&/g,'&amp;').replace(/</g,'&lt;')}</Data></Cell>`).join('')}</Row>`).join(''); return xmlHead+body+`</Table></Worksheet></Workbook>` }

/* ====== —Ä–µ–Ω–¥–µ—Ä ====== */
async function render(){
  setTabs(); drawTabs();
  document.getElementById('who').textContent=state.user?.name||'‚Äî';
  const hash=location.hash.slice(1)||state.tabs[0].id;
  if(hash==='mine') await viewMine();
  if(hash==='total') await viewTotal();
  if(hash==='manage') await viewManage();
  if(hash==='history') await viewHistory();
}

/* ====== –∑–∞–ø—É—Å–∫ ====== */
(async function boot(){
  await ensureSeed();
  try{ const u=JSON.parse(localStorage.getItem('inv_user')||'null'); if(u&&u.id) state.user=u; }catch(_){}
  if(!state.user){ document.getElementById('loginScreen').style.display=''; }
  else { document.getElementById('loginScreen').style.display='none'; render(); }
})();
</script>
</body>
</html>
